description: Builds an open container initiative (OCI) image
name: github.com/opspec-pkgs/opencontainers.image.build
inputs:
  registryCreds:
    array:
      default:
        - $(opctl://./secrets/docker.io)
      description: |
        creds for image registries e.g. `["username": "xx", "password": "yy", "registry": "https://index.docker.io/v1/"]`
      constraints: 
        items:
          type: object
          properties:
            username:
              type: string
            password:
              type: string
            registry:
              type: string
  cache:
    dir:
      default: /default_cache
      description: Directory used to cache images/layers across runs. Must be formatted as an [image-layout](https://github.com/opencontainers/image-spec/blob/v1.0.1/image-layout.md)
  context:
    dir:
      description: Context for build
      default: /default_context
  contextIgnore:
    file:
      description: Context ignore rules in the format of a .gitignore/.dockerignore
      default: /default_context_ignore
  instructions:
    file:
      description: Build instructions in the format of a Containerfile/Dockerfile
  isPushEnabled:
    boolean:
      default: false
      description: Whether to push the named images (to remote registries) after they're created
  namesCsv:
    string:
      default: ''
      description: |
        Names the image will be tagged with in the form of comma separated "[registry/][username/][repository/][:tag]"
        
        e.g. 'docker.io/my-org-name/my-repo-name:my-image-tag'
  platformsCsv:
    string:
      default: ''
      description: |
        Platforms the image will be built for in the form of comma separated [platform specifiers](https://github.com/containerd/containerd/blob/8686ededfc90076914c5238eb96c883ea093a8ba/platforms/platforms.go#L63)
        
        e.g. 'linux/amd64,linux/arm64'

outputs:
  image:
    dir:
      description: image in form of [v1.0.1 OCI (Open Container Initiative) `image-layout`](https://github.com/opencontainers/image-spec/blob/v1.0.1/image-layout.md)
run:
  container:
    cmd:
      - sh
      - -ce
      - 
        /setAuths &&

        buildctl-daemonless.sh
        build
        --frontend dockerfile.v0
        --local context=/context
        --local dockerfile=/
        --import-cache type=local,src=/cache
        --export-cache type=local,dest=/cache,mode=max
        --opt platform=$(platformsCsv)
        --output type=image,name=$(namesCsv),push=$(isPushEnabled)
        --output type=oci,'name=$(namesCsv)',tar=false,dest=/image
    dirs:
      /context: $(context)
      /cache: $(cache)
      /image: $(image)     
    envVars:
      registryCreds:
    files:
      /Dockerfile: $(instructions)
      /Dockerfile.dockerignore: $(contextIgnore)
      /setAuths:
    image:
      ref: moby/buildkit:latest
version: 2.0.0
