description: Builds an open container initiative (OCI) image
name: github.com/opspec-pkgs/opencontainers.image.build
opspec: 0.1.6
inputs:
  cacheDir:
    dir:
      default: /default_cache
      description: directory used to cache images/layers across runs. Must be formatted as an [image-layout](https://github.com/opencontainers/image-spec/blob/v1.0.1/image-layout.md)
  context:
    dir:
      description: context for build
      default: /default_context
  contextIgnore:
    file:
      description: context ignore rules in the format of a .gitignore/.dockerignore
      default: /default_context_ignore
  instructions:
    file:
      description: build instructions in the format of a Containerfile/Dockerfile
  username:
    string:
      description: username for auth w/ private registry
      default: ''
  password:
    string:
      description: password for auth w/ private registry
      default: ''
      isSecret: true
  registry:
    string:
      description: private registry to pull image from
      default: docker.io
outputs:
  image:
    dir:
      description: image in form of [v1.0.1 OCI (Open Container Initiative) `image-layout`](https://github.com/opencontainers/image-spec/blob/v1.0.1/image-layout.md)
run:
  serial:
    - op:
        ref: github.com/opspec-pkgs/base64.encode#1.1.0
        inputs:
          rawValue: $(username):$(password)
        outputs:
          encodedValue:
    - container:
        cmd: [ /cmd.sh ]
        files:
          /cmd.sh:
          /Dockerfile: $(instructions)
          /Dockerfile.dockerignore: $(contextIgnore)
          /root/.docker/config.json: 
            auths:
              $(registry):
                auth: $(encodedValue)
        dirs:
          /buildContext: $(context)
          /cacheDir: $(cacheDir)
          /image: $(image)
        envVars:
          password:
          registry:
          username:
        image: { ref: moby/buildkit:master}
version: 1.1.1
